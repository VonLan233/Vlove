<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="vlove---vr%E6%89%8B%E5%8A%BF%E8%AF%86%E5%88%AB%E6%89%8B%E5%A5%97%E4%B8%8E%E7%A9%BA%E6%B0%94%E7%90%B4">Vlove - VR手势识别手套与空气琴</h1>
<p align="center">
  <strong>&#x57FA;&#x4E8E;ESP32&#x7684;&#x667A;&#x80FD;&#x624B;&#x5957;&#x7CFB;&#x7EDF;&#xFF0C;&#x96C6;&#x6210;&#x624B;&#x52BF;&#x8BC6;&#x522B;&#x4E0E;&#x7A7A;&#x6C14;&#x7434;&#x529F;&#x80FD;</strong>
</p>
<hr>
<h2 id="%E7%9B%AE%E5%BD%95">目录</h2>
<ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</a></li>
<li><a href="#%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7">功能特性</a></li>
<li><a href="#%E7%A1%AC%E4%BB%B6%E8%A6%81%E6%B1%82">硬件要求</a></li>
<li><a href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始</a></li>
<li><a href="#%E5%9B%BA%E4%BB%B6%E6%9E%B6%E6%9E%84">固件架构</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E">配置说明</a></li>
<li><a href="#%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83">命令参考</a></li>
<li><a href="#%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE">通信协议</a></li>
<li><a href="#python%E5%AE%A2%E6%88%B7%E7%AB%AF">Python客户端</a></li>
<li><a href="#%E6%89%8B%E5%8A%BF%E5%AE%9A%E4%B9%89">手势定义</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">故障排除</a></li>
</ul>
<hr>
<h2 id="%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</h2>
<p>Vlove是一个开源的VR手套项目，灵感来源于<a href="https://github.com/LucidVR/lucidgloves">LucidGloves</a>。项目采用模块化C++架构，支持手势识别、空气琴演奏和原始数据输出三种工作模式。</p>
<h3 id="%E6%8A%80%E6%9C%AF%E8%A7%84%E6%A0%BC">技术规格</h3>
<table>
<thead>
<tr>
<th>项目</th>
<th>规格</th>
</tr>
</thead>
<tbody>
<tr>
<td>主控芯片</td>
<td>ESP32 DOIT V1</td>
</tr>
<tr>
<td>传感器</td>
<td>5路电位器 (线拉式)</td>
</tr>
<tr>
<td>采样频率</td>
<td>100 Hz</td>
</tr>
<tr>
<td>ADC分辨率</td>
<td>12位 (0-4095)</td>
</tr>
<tr>
<td>通信方式</td>
<td>USB串口 / 蓝牙</td>
</tr>
<tr>
<td>波特率</td>
<td>115200 bps</td>
</tr>
<tr>
<td>循环周期</td>
<td>10 ms</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7">功能特性</h2>
<h3 id="1-%E6%89%8B%E5%8A%BF%E8%AF%86%E5%88%AB%E6%A8%A1%E5%BC%8F-g">1. 手势识别模式 (G)</h3>
<p>支持20种预定义手势的实时识别：</p>
<ul>
<li><strong>数字手势</strong>: 0-9</li>
<li><strong>通用手势</strong>: 👍 👎 ✌️ 🤘 👌 ✊ 🖐️ 👆 🤙</li>
</ul>
<p><strong>特点</strong>:</p>
<ul>
<li>3次去抖确认，有效避免误触发</li>
<li>响应延迟约30ms</li>
<li>基于手指开/闭/半开状态的规则匹配</li>
</ul>
<h3 id="2-%E7%A9%BA%E6%B0%94%E7%90%B4%E6%A8%A1%E5%BC%8F">2. 空气琴模式</h3>
<p>三种钢琴演奏模式，音符映射到C大调音阶：</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>P1</td>
<td>单音模式</td>
<td>每根手指对应一个音符 (C4-G4)，支持力度控制</td>
</tr>
<tr>
<td>P2</td>
<td>滑音模式</td>
<td>中指控制音符开关，食指控制音高弯曲 (±2半音)</td>
</tr>
<tr>
<td>P3</td>
<td>和弦模式</td>
<td>多根手指组合形成和弦，自动检测和弦变化</td>
</tr>
</tbody>
</table>
<p><strong>MIDI音符映射</strong>:</p>
<pre class="hljs"><code><div>拇指 → C4 (60)
食指 → D4 (62)
中指 → E4 (64)
无名指 → F4 (65)
小指 → G4 (67)
</div></code></pre>
<h3 id="3-%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%BC%8F-r">3. 原始数据模式 (R)</h3>
<p>输出传感器的原始值和校准后的映射值，适用于：</p>
<ul>
<li>调试和故障排查</li>
<li>自定义应用开发</li>
<li>数据采集与分析</li>
</ul>
<h3 id="4-%E8%87%AA%E5%8A%A8%E6%A0%A1%E5%87%86%E7%B3%BB%E7%BB%9F">4. 自动校准系统</h3>
<ul>
<li>最小值/最大值动态捕获</li>
<li>EEPROM持久化存储</li>
<li>线性映射到0-4095范围</li>
<li>异常校准警告机制</li>
</ul>
<h3 id="5-opengloves%E5%8D%8F%E8%AE%AE-vr%E6%A8%A1%E5%BC%8F">5. OpenGloves协议 (VR模式)</h3>
<p>支持SteamVR集成，兼容<a href="https://github.com/LucidVR/opengloves-driver">OpenGloves驱动</a>：</p>
<ul>
<li>Alpha编码格式输出</li>
<li>支持手指弯曲追踪</li>
<li>可选IMU姿态数据</li>
</ul>
<h3 id="6-imu%E5%A7%BF%E6%80%81%E8%BF%BD%E8%B8%AA-%E5%8F%AF%E9%80%89">6. IMU姿态追踪 (可选)</h3>
<p>支持MPU6050 6轴IMU：</p>
<ul>
<li>Madgwick AHRS姿态融合算法</li>
<li>四元数输出</li>
<li>自动校准陀螺仪偏移</li>
</ul>
<hr>
<h2 id="%E7%A1%AC%E4%BB%B6%E8%A6%81%E6%B1%82">硬件要求</h2>
<h3 id="%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">工作原理</h3>
<p>采用线拉式电位器设计：</p>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────┐
│                                                         │
│   指尖 ←──── 拉线 ←──── 电位器 ←──── ESP32 ADC        │
│                           │                             │
│                        旋转轴                           │
│                                                         │
└─────────────────────────────────────────────────────────┘

手指弯曲 → 拉动线 → 电位器旋转 → 阻值变化 → ADC读数变化
</div></code></pre>
<p><strong>原理说明</strong>：</p>
<ol>
<li>线的一端固定在指尖，另一端缠绕在电位器轴上</li>
<li>手指弯曲时拉动线，带动电位器旋转</li>
<li>电位器输出电压随旋转角度变化</li>
<li>ESP32的ADC读取电压值，映射为手指位置 (0-4095)</li>
</ol>
<h3 id="esp32%E5%BC%95%E8%84%9A%E9%85%8D%E7%BD%AE">ESP32引脚配置</h3>
<table>
<thead>
<tr>
<th>手指</th>
<th>GPIO</th>
<th>ADC通道</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>拇指 (Thumb)</td>
<td>36</td>
<td>ADC1_0</td>
<td>仅输入</td>
</tr>
<tr>
<td>食指 (Index)</td>
<td>39</td>
<td>ADC1_3</td>
<td>仅输入</td>
</tr>
<tr>
<td>中指 (Middle)</td>
<td>34</td>
<td>ADC1_6</td>
<td>仅输入</td>
</tr>
<tr>
<td>无名指 (Ring)</td>
<td>35</td>
<td>ADC1_7</td>
<td>仅输入</td>
</tr>
<tr>
<td>小指 (Pinky)</td>
<td>32</td>
<td>ADC1_4</td>
<td>支持输入输出</td>
</tr>
<tr>
<td>LED状态灯</td>
<td>2</td>
<td>-</td>
<td>可选</td>
</tr>
</tbody>
</table>
<h3 id="%E7%94%B5%E4%BD%8D%E5%99%A8%E6%8E%A5%E7%BA%BF">电位器接线</h3>
<p>每个电位器有3个引脚：</p>
<pre class="hljs"><code><div>电位器引脚:
  ┌───┐
  │ 1 │ ── VCC (3.3V)
  │ 2 │ ── 信号输出 (接ESP32 GPIO)
  │ 3 │ ── GND
  └───┘

接线示意:
  ESP32 3.3V ────┬────┬────┬────┬──── 电位器1 VCC
                 │    │    │    └──── 电位器2 VCC
                 │    │    └───────── ...
                 │    └────────────── 电位器5 VCC
                 │
  ESP32 GND ─────┴────┴────┴────┴──── 所有电位器 GND

  GPIO 36 ────────────────────────── 电位器1 信号 (拇指)
  GPIO 39 ────────────────────────── 电位器2 信号 (食指)
  GPIO 34 ────────────────────────── 电位器3 信号 (中指)
  GPIO 35 ────────────────────────── 电位器4 信号 (无名指)
  GPIO 32 ────────────────────────── 电位器5 信号 (小指)
</div></code></pre>
<h3 id="%E6%8E%A8%E8%8D%90%E5%85%83%E4%BB%B6">推荐元件</h3>
<table>
<thead>
<tr>
<th>元件</th>
<th>规格</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>电位器</td>
<td>10kΩ 旋转电位器</td>
<td>5个</td>
</tr>
<tr>
<td>拉线</td>
<td>钓鱼线/编织线 0.3-0.5mm</td>
<td>适量</td>
</tr>
<tr>
<td>ESP32</td>
<td>DOIT DevKit V1</td>
<td>1个</td>
</tr>
<tr>
<td>MPU6050</td>
<td>6轴IMU模块 (可选)</td>
<td>1个</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意</strong>: ESP32的ADC输入范围为0-3.3V，电位器VCC必须接3.3V而非5V。</p>
</blockquote>
<h3 id="imu%E6%8E%A5%E7%BA%BF-%E5%8F%AF%E9%80%89">IMU接线 (可选)</h3>
<p>如需手部姿态追踪功能，添加MPU6050模块：</p>
<pre class="hljs"><code><div>MPU6050          ESP32
  VCC     →     3.3V
  GND     →     GND
  SCL     →     GPIO 22
  SDA     →     GPIO 21
</div></code></pre>
<blockquote>
<p><strong>提示</strong>: 如不需要IMU功能，可在 <code>Config.h</code> 中注释掉 <code>#define ENABLE_IMU</code></p>
</blockquote>
<hr>
<h2 id="%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始</h2>
<h3 id="1-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">1. 安装依赖</h3>
<p><strong>Arduino IDE配置</strong>:</p>
<ol>
<li>安装 <a href="https://github.com/espressif/arduino-esp32">ESP32 Arduino Core</a></li>
<li>选择开发板: <code>ESP32 Dev Module</code></li>
<li>选择端口</li>
</ol>
<h3 id="2-%E4%B8%8A%E4%BC%A0%E5%9B%BA%E4%BB%B6">2. 上传固件</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># 项目结构</span>
Vlove/
├── firmware/
│   ├── Vlove.ino          <span class="hljs-comment"># 主程序入口</span>
│   └── src/               <span class="hljs-comment"># 模块源码</span>
└── python/                <span class="hljs-comment"># Python客户端</span>
</div></code></pre>
<ol>
<li>打开 <code>firmware/Vlove.ino</code></li>
<li>选择开发板和端口</li>
<li>点击上传</li>
</ol>
<h3 id="3-%E9%A6%96%E6%AC%A1%E6%A0%A1%E5%87%86">3. 首次校准</h3>
<p>首次启动会自动进入校准模式：</p>
<pre class="hljs"><code><div>****************************************
*       CALIBRATION MODE ACTIVE        *
****************************************

Move ALL fingers through full range:
  1. Make a tight fist
  2. Open hand fully
  3. Repeat several times

Type 'DONE' or press ENTER when finished.
</div></code></pre>
<p><strong>校准步骤</strong>:</p>
<ol>
<li>完全握拳 → 完全张开手掌</li>
<li>重复3-5次，确保覆盖完整活动范围</li>
<li>输入 <code>DONE</code> 或按回车完成校准</li>
</ol>
<h3 id="4-%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8">4. 开始使用</h3>
<p>校准完成后自动进入手势识别模式：</p>
<pre class="hljs"><code><div>========================================
  Vlove Ready - Gesture Mode
========================================
Commands: G/P1/P2/P3/R | CAL | BT | HELP
</div></code></pre>
<hr>
<h2 id="%E5%9B%BA%E4%BB%B6%E6%9E%B6%E6%9E%84">固件架构</h2>
<h3 id="%E6%A8%A1%E5%9D%97%E7%BB%93%E6%9E%84">模块结构</h3>
<pre class="hljs"><code><div>firmware/
├── Vlove.ino                 # 主程序
│   ├── setup()               # 初始化
│   ├── loop()                # 主循环
│   ├── handleCommands()      # 命令处理
│   └── processXxxMode()      # 模式处理函数
│
└── src/
    ├── Config.h              # 配置定义
    │   ├── 引脚配置
    │   ├── 阈值定义
    │   ├── 枚举类型
    │   └── MIDI音符
    │
    ├── Calibration.h         # 校准模块
    │   ├── begin()           # 初始化EEPROM
    │   ├── startCalibration()
    │   ├── update()          # 更新min/max
    │   ├── stopCalibration()
    │   ├── mapValue()        # 值映射
    │   └── saveToEEPROM()    # 持久化
    │
    ├── GestureRecognizer.h   # 手势识别
    │   ├── update()          # 更新识别
    │   ├── getCurrentGesture()
    │   └── getGestureName()
    │
    ├── AirPiano.h            # 空气琴
    │   ├── update()          # 处理输入
    │   ├── getEvent()        # 获取事件
    │   └── setMode()         # 设置模式
    │
    └── Communication.h       # 通信模块
        ├── begin()           # 初始化
        ├── toggleBluetooth()
        ├── sendGesture()
        ├── sendPianoEvent()
        └── sendRawData()
</div></code></pre>
<h3 id="%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">工作流程</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────┐
│                      启动                           │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│  初始化串口 → 加载EEPROM → 检查校准数据             │
└─────────────────────────────────────────────────────┘
                         │
           ┌─────────────┴─────────────┐
           │ 有效校准?                  │
           ▼                           ▼
     ┌──────────┐               ┌──────────┐
     │ 正常启动 │               │ 校准模式 │
     └──────────┘               └──────────┘
           │                           │
           └─────────────┬─────────────┘
                         ▼
┌─────────────────────────────────────────────────────┐
│                   主循环 (10ms)                      │
│  ┌─────────────────────────────────────────────┐    │
│  │ 1. 读取串口命令                              │    │
│  │ 2. 读取5路ADC传感器                          │    │
│  │ 3. 应用校准映射                              │    │
│  │ 4. 根据模式处理数据                          │    │
│  │ 5. 发送输出                                  │    │
│  └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
</div></code></pre>
<hr>
<h2 id="%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E">配置说明</h2>
<p>所有配置位于 <code>src/Config.h</code>：</p>
<h3 id="%E5%BC%95%E8%84%9A%E9%85%8D%E7%BD%AE">引脚配置</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIN_THUMB   36</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIN_INDEX   39</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIN_MIDDLE  34</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIN_RING    35</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIN_PINKY   32</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIN_LED     2</span>
</div></code></pre>
<h3 id="%E9%98%88%E5%80%BC%E9%85%8D%E7%BD%AE">阈值配置</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FINGER_OPEN_THRESHOLD    3000  <span class="hljs-comment">// 手指打开阈值</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FINGER_CLOSED_THRESHOLD  1000  <span class="hljs-comment">// 手指闭合阈值</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FINGER_HALF_THRESHOLD    2000  <span class="hljs-comment">// 手指半开阈值</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GESTURE_DEBOUNCE_COUNT   3     <span class="hljs-comment">// 手势去抖次数</span></span>
</div></code></pre>
<h3 id="%E9%92%A2%E7%90%B4%E9%98%88%E5%80%BC">钢琴阈值</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NOTE_ON_THRESHOLD   1500  <span class="hljs-comment">// 音符触发阈值</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NOTE_OFF_THRESHOLD  2500  <span class="hljs-comment">// 音符释放阈值</span></span>
</div></code></pre>
<h3 id="%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE">系统配置</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BAUD_RATE      115200</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOOP_DELAY_MS  10</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ANALOG_MAX     4095</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EEPROM_SIZE    512</span>
</div></code></pre>
<hr>
<h2 id="%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83">命令参考</h2>
<p>通过串口发送命令控制设备：</p>
<h3 id="%E6%A8%A1%E5%BC%8F%E5%88%87%E6%8D%A2">模式切换</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>别名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>G</code></td>
<td><code>GESTURE</code></td>
<td>切换到手势识别模式</td>
</tr>
<tr>
<td><code>P1</code></td>
<td><code>PIANO1</code></td>
<td>切换到单音模式</td>
</tr>
<tr>
<td><code>P2</code></td>
<td><code>PIANO2</code></td>
<td>切换到滑音模式</td>
</tr>
<tr>
<td><code>P3</code></td>
<td><code>PIANO3</code></td>
<td>切换到和弦模式</td>
</tr>
<tr>
<td><code>R</code></td>
<td><code>RAW</code></td>
<td>切换到原始数据模式</td>
</tr>
<tr>
<td><code>VR</code></td>
<td><code>OPENGLOVES</code> / <code>OG</code></td>
<td>切换到OpenGloves模式 (SteamVR)</td>
</tr>
</tbody>
</table>
<h3 id="%E6%A0%A1%E5%87%86%E6%8E%A7%E5%88%B6">校准控制</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CAL</code></td>
<td>启动校准模式</td>
</tr>
<tr>
<td><code>DONE</code> / <code>STOP</code></td>
<td>完成校准</td>
</tr>
<tr>
<td><code>CLEAR</code></td>
<td>清除EEPROM并重新校准</td>
</tr>
</tbody>
</table>
<h3 id="%E7%A1%AC%E4%BB%B6%E6%8E%A7%E5%88%B6">硬件控制</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BT</code></td>
<td>开启/关闭蓝牙</td>
</tr>
<tr>
<td><code>IMU</code></td>
<td>显示当前IMU姿态数据</td>
</tr>
<tr>
<td><code>IMUCAL</code></td>
<td>校准IMU陀螺仪</td>
</tr>
<tr>
<td><code>HELP</code> / <code>H</code> / <code>?</code></td>
<td>显示帮助信息</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE">通信协议</h2>
<h3 id="%E6%89%8B%E5%8A%BF%E6%95%B0%E6%8D%AE%E5%B8%A7">手势数据帧</h3>
<pre class="hljs"><code><div>G,&lt;gesture_id&gt;,&lt;gesture_name&gt;
</div></code></pre>
<p><strong>示例</strong>:</p>
<pre class="hljs"><code><div>G,1,One        # 数字1
G,13,Peace     # ✌️ 手势
G,11,ThumbsUp  # 👍 手势
</div></code></pre>
<h3 id="%E9%92%A2%E7%90%B4%E6%95%B0%E6%8D%AE%E5%B8%A7">钢琴数据帧</h3>
<p><strong>单音模式</strong>:</p>
<pre class="hljs"><code><div>P,ON,&lt;note&gt;,&lt;velocity&gt;    # 音符开始
P,OFF,&lt;note&gt;              # 音符结束
</div></code></pre>
<p><strong>滑音模式</strong>:</p>
<pre class="hljs"><code><div>P,BEND,&lt;note&gt;,&lt;pitch_bend&gt;  # pitch_bend: -8192 ~ 8191
</div></code></pre>
<p><strong>和弦模式</strong>:</p>
<pre class="hljs"><code><div>P,ON,CHORD,&lt;note1&gt;,&lt;note2&gt;,...
P,OFF,CHORD,&lt;note1&gt;,&lt;note2&gt;,...
</div></code></pre>
<p><strong>示例</strong>:</p>
<pre class="hljs"><code><div>P,ON,64,100           # E4音符开始，力度100
P,OFF,64              # E4音符结束
P,BEND,64,4096        # E4音高上弯
P,ON,CHORD,60,64,67   # C大三和弦开始
P,OFF,CHORD,60,64,67  # C大三和弦结束
</div></code></pre>
<h3 id="%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E5%B8%A7">原始数据帧</h3>
<pre class="hljs"><code><div>R,&lt;raw0&gt;,&lt;raw1&gt;,&lt;raw2&gt;,&lt;raw3&gt;,&lt;raw4&gt;,&lt;map0&gt;,&lt;map1&gt;,&lt;map2&gt;,&lt;map3&gt;,&lt;map4&gt;
</div></code></pre>
<p><strong>示例</strong>:</p>
<pre class="hljs"><code><div>R,1024,2048,3072,1500,2500,512,1024,2048,750,1500
</div></code></pre>
<h3 id="opengloves%E6%95%B0%E6%8D%AE%E5%B8%A7-vr%E6%A8%A1%E5%BC%8F">OpenGloves数据帧 (VR模式)</h3>
<p>兼容OpenGloves驱动的Alpha编码格式：</p>
<p><strong>仅手指数据</strong>:</p>
<pre class="hljs"><code><div>A&lt;thumb&gt;B&lt;index&gt;C&lt;middle&gt;D&lt;ring&gt;E&lt;pinky&gt;
</div></code></pre>
<p><strong>包含IMU四元数</strong>:</p>
<pre class="hljs"><code><div>A&lt;thumb&gt;B&lt;index&gt;C&lt;middle&gt;D&lt;ring&gt;E&lt;pinky&gt;(qw|qx|qy|qz)
</div></code></pre>
<p><strong>示例</strong>:</p>
<pre class="hljs"><code><div>A2048B3000C3500D2800E2500                    # 仅手指
A2048B3000C3500D2800E2500(0.9239|0.0|0.3827|0.0)  # 含IMU
</div></code></pre>
<hr>
<h2 id="steamvr%E9%9B%86%E6%88%90">SteamVR集成</h2>
<h3 id="1-%E5%AE%89%E8%A3%85opengloves%E9%A9%B1%E5%8A%A8">1. 安装OpenGloves驱动</h3>
<ol>
<li>下载 <a href="https://github.com/LucidVR/opengloves-driver/releases">OpenGloves Driver</a></li>
<li>解压到SteamVR的 <code>drivers</code> 目录</li>
<li>启动SteamVR</li>
</ol>
<h3 id="2-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8">2. 配置驱动</h3>
<p>编辑 <code>opengloves/resources/settings/default.vrsettings</code>：</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"communication_protocol"</span>: <span class="hljs-string">"serial"</span>,
  <span class="hljs-attr">"serial_port"</span>: <span class="hljs-string">"COM3"</span>,  <span class="hljs-comment">// 或 /dev/ttyUSB0</span>
  <span class="hljs-attr">"encoding_protocol"</span>: <span class="hljs-string">"alpha"</span>
}
</div></code></pre>
<h3 id="3-%E5%90%AF%E5%8A%A8%E6%89%8B%E5%A5%97">3. 启动手套</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># ESP32切换到VR模式</span>
VR
<span class="hljs-comment"># 或</span>
OPENGLOVES
</div></code></pre>
<p>SteamVR应自动检测并显示手部模型。</p>
<hr>
<h2 id="python%E5%AE%A2%E6%88%B7%E7%AB%AF">Python客户端</h2>
<h3 id="%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">安装依赖</h3>
<pre class="hljs"><code><div>pip install pyserial numpy sounddevice
</div></code></pre>
<h3 id="%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">使用方法</h3>
<pre class="hljs"><code><div><span class="hljs-built_in">cd</span> Vlove/python

<span class="hljs-comment"># 自动检测串口</span>
python vlove_client.py

<span class="hljs-comment"># 指定串口</span>
python vlove_client.py /dev/cu.usbserial-110   <span class="hljs-comment"># macOS</span>
python vlove_client.py COM3                     <span class="hljs-comment"># Windows</span>
python vlove_client.py /dev/ttyUSB0             <span class="hljs-comment"># Linux</span>
</div></code></pre>
<h3 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8A%9F%E8%83%BD">客户端功能</h3>
<ul>
<li>自动检测ESP32串口 (CH340/CP210x/usbserial)</li>
<li>解析手势、钢琴、原始数据</li>
<li>实时音频反馈 (正弦波合成)</li>
<li>支持MIDI音符播放和音高弯曲</li>
</ul>
<h3 id="%E6%A8%A1%E5%9D%97%E8%AF%B4%E6%98%8E">模块说明</h3>
<table>
<thead>
<tr>
<th>文件</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vlove_client.py</code></td>
<td>主程序，串口通信和数据解析</td>
</tr>
<tr>
<td><code>audio_player.py</code></td>
<td>音频引擎，波形合成和播放</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%E6%89%8B%E5%8A%BF%E5%AE%9A%E4%B9%89">手势定义</h2>
<h3 id="%E6%95%B0%E5%AD%97%E6%89%8B%E5%8A%BF-0-9">数字手势 (0-9)</h3>
<table>
<thead>
<tr>
<th>手势</th>
<th style="text-align:center">拇指</th>
<th style="text-align:center">食指</th>
<th style="text-align:center">中指</th>
<th style="text-align:center">无名指</th>
<th style="text-align:center">小指</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 / ✊</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
</tr>
<tr>
<td>1</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
</tr>
<tr>
<td>2 / ✌️</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
</tr>
<tr>
<td>4</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
</tr>
<tr>
<td>5 / 🖐️</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
</tr>
<tr>
<td>6 / 🤙</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
</tr>
<tr>
<td>7</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
</tr>
<tr>
<td>8</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
</tr>
<tr>
<td>9 / 👍</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
</tr>
</tbody>
</table>
<h3 id="%E7%89%B9%E6%AE%8A%E6%89%8B%E5%8A%BF">特殊手势</h3>
<table>
<thead>
<tr>
<th>手势</th>
<th style="text-align:center">拇指</th>
<th style="text-align:center">食指</th>
<th style="text-align:center">中指</th>
<th style="text-align:center">无名指</th>
<th style="text-align:center">小指</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>🤘 Rock</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">开</td>
<td>摇滚手势</td>
</tr>
<tr>
<td>👌 OK</td>
<td style="text-align:center">半</td>
<td style="text-align:center">半</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td style="text-align:center">开</td>
<td>OK手势</td>
</tr>
<tr>
<td>👆 Point</td>
<td style="text-align:center">半</td>
<td style="text-align:center">开</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td style="text-align:center">关</td>
<td>指向手势</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>图例</strong>: 开 = 手指伸直, 关 = 手指弯曲, 半 = 手指半弯</p>
</blockquote>
<hr>
<h2 id="%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">故障排除</h2>
<h3 id="%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</h3>
<p><strong>Q: 上传固件失败</strong></p>
<ul>
<li>检查是否选择正确的开发板 (ESP32 Dev Module)</li>
<li>尝试按住BOOT按钮后再上传</li>
<li>检查USB线是否支持数据传输</li>
</ul>
<p><strong>Q: 串口无输出</strong></p>
<ul>
<li>确认波特率设置为115200</li>
<li>检查串口监视器的换行设置</li>
<li>尝试重启ESP32</li>
</ul>
<p><strong>Q: 校准后手势识别不准确</strong></p>
<ul>
<li>重新执行校准，确保完整活动范围</li>
<li>检查传感器接线是否松动</li>
<li>使用 <code>R</code> 命令查看原始数据是否正常</li>
</ul>
<p><strong>Q: 蓝牙无法连接</strong></p>
<ul>
<li>确认已执行 <code>BT</code> 命令开启蓝牙</li>
<li>设备名称为 &quot;Vlove&quot;</li>
<li>检查手机/电脑蓝牙是否开启</li>
</ul>
<p><strong>Q: Python客户端找不到串口</strong></p>
<ul>
<li>手动指定串口路径</li>
<li>检查串口驱动是否安装 (CH340/CP210x)</li>
<li>确认ESP32已通过USB连接</li>
</ul>
<h3 id="%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7">调试技巧</h3>
<ol>
<li><strong>使用原始数据模式</strong>: 发送 <code>R</code> 命令查看传感器原始值</li>
<li><strong>检查校准范围</strong>: 校准后的min/max值应有足够差值 (&gt;500)</li>
<li><strong>查看串口输出</strong>: 系统启动时会输出校准状态信息</li>
</ol>
<hr>
<h2 id="%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">项目结构</h2>
<pre class="hljs"><code><div>Vlove/
├── firmware/                    # ESP32固件
│   ├── Vlove.ino               # 主程序
│   └── src/
│       ├── Config.h            # 配置文件
│       ├── Calibration.h       # 校准模块
│       ├── GestureRecognizer.h # 手势识别
│       ├── AirPiano.h          # 空气琴
│       ├── Communication.h     # 通信模块 (含OpenGloves)
│       └── IMU.h               # IMU模块 (MPU6050)
│
├── python/                      # Python客户端
│   ├── vlove_client.py         # 主程序
│   └── audio_player.py         # 音频播放
│
└── README.md                    # 本文档
</div></code></pre>
<hr>
<h2 id="%E6%9C%AA%E6%9D%A5%E8%AE%A1%E5%88%92">未来计划</h2>
<ul>
<li><input type="checkbox" id="checkbox0" checked="true"><label for="checkbox0"></label><strong>OpenGloves协议</strong> - 集成SteamVR支持 ✅ 已完成</li>
<li><input type="checkbox" id="checkbox1" checked="true"><label for="checkbox1"></label><strong>IMU姿态追踪</strong> - 添加MPU6050实现手部旋转追踪 ✅ 已完成</li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2"></label><strong>机器学习手势识别</strong> - 用KNN/决策树替代硬编码规则，支持自定义手势训练</li>
<li><input type="checkbox" id="checkbox3" checked="true"><label for="checkbox3"></label><strong>力反馈</strong> - 舵机驱动的触觉反馈</li>
<li><input type="checkbox" id="checkbox4" checked="true"><label for="checkbox4"></label><strong>3D打印外壳</strong> - 完整的硬件设计文件</li>
</ul>
<hr>
<h2 id="%E8%87%B4%E8%B0%A2">致谢</h2>
<p>本项目参考了 <a href="https://github.com/LucidVR/lucidgloves">LucidGloves</a> 的设计思路和架构。</p>
<hr>
<h2 id="%E8%AE%B8%E5%8F%AF%E8%AF%81">许可证</h2>
<p>MIT License</p>

</body>
</html>
